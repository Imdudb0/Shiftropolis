name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate-android-setup:
    name: Validate Android Configuration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libudev-dev pkg-config

    - name: Install Rust with Android target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: armv7-linux-androideabi

    - name: Install cargo-apk
      run: cargo install cargo-apk

    - name: Validate Cargo.toml Android config
      run: |
        # Vérifier que les métadonnées Android sont présentes
        if ! grep -q "package.metadata.android" Cargo.toml; then
          echo "❌ Métadonnées Android manquantes dans Cargo.toml"
          exit 1
        fi

        # Vérifier les dépendances Android critiques
        if ! grep -q "bevy.*android-game-activity" Cargo.toml; then
          echo "❌ Support Android manquant pour Bevy"
          exit 1
        fi

        echo "✅ Configuration Android validée"

    - name: Check Android compilation (dry-run)
      run: |
        # Test de compilation sans build complet pour Android
        # Utiliser --no-default-features pour éviter les dépendances desktop
        cargo check --target armv7-linux-androideabi --no-default-features --features android

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [test, validate-android-setup, security-audit]
    if: always()

    steps:
    - name: Notify success
      if: needs.test.result == 'success' && needs.validate-android-setup.result == 'success' && needs.security-audit.result == 'success'
      run: |
        echo "✅ Tous les tests sont passés!" >> $GITHUB_STEP_SUMMARY
        echo "🚀 Le code est prêt pour le build Android" >> $GITHUB_STEP_SUMMARY

    - name: Notify failure
      if: needs.test.result == 'failure' || needs.validate-android-setup.result == 'failure' || needs.security-audit.result == 'failure'
      run: |
        echo "❌ Certains tests ont échoué" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Config Android: ${{ needs.validate-android-setup.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Sécurité: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
