name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate-android-setup:
    name: Validate Android Configuration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libudev-dev pkg-config

    - name: Install Rust with Android target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: armv7-linux-androideabi

    - name: Install cargo-apk
      run: cargo install cargo-apk

    - name: Validate Cargo.toml Android config
      run: |
        # VÃ©rifier que les mÃ©tadonnÃ©es Android sont prÃ©sentes
        if ! grep -q "package.metadata.android" Cargo.toml; then
          echo "âŒ MÃ©tadonnÃ©es Android manquantes dans Cargo.toml"
          exit 1
        fi

        # VÃ©rifier les dÃ©pendances Android critiques
        if ! grep -q "bevy.*android-game-activity" Cargo.toml; then
          echo "âŒ Support Android manquant pour Bevy"
          exit 1
        fi

        echo "âœ… Configuration Android validÃ©e"

    - name: Check Android compilation (dry-run)
      run: |
        # Test de compilation sans build complet pour Android
        # Utiliser --no-default-features pour Ã©viter les dÃ©pendances desktop
        cargo check --target armv7-linux-androideabi --no-default-features --features android

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [test, validate-android-setup, security-audit]
    if: always()

    steps:
    - name: Notify success
      if: needs.test.result == 'success' && needs.validate-android-setup.result == 'success' && needs.security-audit.result == 'success'
      run: |
        echo "âœ… Tous les tests sont passÃ©s!" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Le code est prÃªt pour le build Android" >> $GITHUB_STEP_SUMMARY

    - name: Notify failure
      if: needs.test.result == 'failure' || needs.validate-android-setup.result == 'failure' || needs.security-audit.result == 'failure'
      run: |
        echo "âŒ Certains tests ont Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Config Android: ${{ needs.validate-android-setup.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- SÃ©curitÃ©: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
