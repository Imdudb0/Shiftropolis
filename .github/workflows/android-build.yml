name: Android Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target: [armv7-linux-androideabi]
        build-type: [debug, release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: google_apis
        arch: x86_64

    - name: Install Android SDK Platform and NDK
      run: |
        # Install required SDK platform and tools
        sdkmanager --install "platforms;android-33" "platform-tools" "build-tools;33.0.2"
        sdkmanager --install "ndk;25.2.9519653"
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cargo-apk
      run: cargo install cargo-apk

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: Setup Android environment
      run: |
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653
        export NDK_HOME=$ANDROID_NDK_ROOT
        export CC_armv7_linux_androideabi="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
        export CXX_armv7_linux_androideabi="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++"
        export AR_armv7_linux_androideabi="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        export CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER="$CC_armv7_linux_androideabi"
        export RUSTFLAGS="-C link-arg=-Wl,--no-rosegment"

        # Save to GITHUB_ENV for subsequent steps
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "CC_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
        echo "CXX_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++" >> $GITHUB_ENV
        echo "AR_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
        echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
        echo "RUSTFLAGS=-C link-arg=-Wl,--no-rosegment" >> $GITHUB_ENV

    - name: Verify Android setup
      run: |
        echo "Android SDK: $ANDROID_HOME"
        echo "Android NDK: $ANDROID_NDK_ROOT"
        ls -la $ANDROID_HOME/platforms/ || echo "No platforms found"
        sdkmanager --list_installed

    - name: Build Android APK (Debug)
      if: matrix.build-type == 'debug'
      run: |
        cargo apk build --target ${{ matrix.target }}

    - name: Build Android APK (Release)
      if: matrix.build-type == 'release'
      run: |
        cargo apk build --release --target ${{ matrix.target }}

    - name: Analyze APK size
      run: |
        if [ "${{ matrix.build-type }}" == "release" ]; then
          APK_PATH="target/${{ matrix.target }}/release/apk/sme-arena-game.apk"
        else
          APK_PATH="target/${{ matrix.target }}/debug/apk/sme-arena-game.apk"
        fi

        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "📦 APK Size (${{ matrix.build-type }}): $APK_SIZE" >> $GITHUB_STEP_SUMMARY

          # Detailed analysis for release
          if [ "${{ matrix.build-type }}" == "release" ]; then
            unzip -l "$APK_PATH" | head -20 >> apk_contents.txt
            echo "📋 APK Contents:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -20 apk_contents.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sme-arena-${{ matrix.target }}-${{ matrix.build-type }}
        path: |
          target/${{ matrix.target }}/${{ matrix.build-type }}/apk/*.apk
          target/${{ matrix.target }}/${{ matrix.build-type }}/lib*.so
        retention-days: 30

    - name: Create GitHub Release
      if: github.event_name == 'release' && matrix.build-type == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: target/${{ matrix.target }}/release/apk/sme-arena-game.apk
        tag_name: ${{ github.ref_name }}
        name: SME Arena ${{ github.ref_name }}
        body: |
          🎮 SME Arena - Survival Mutations Engine

          **Android APK for ARMv7**

          🔥 **New Features:**
          - Procedural 3D arena generation
          - SME mutation system
          - Optimized touch controls
          - Responsive UI

          📱 **Installation:**
          1. Download the APK file
          2. Enable "Unknown sources" on Android
          3. Install the APK
          4. Enjoy the game!

          ⚠️ **Requirements:** Android 8.0+ (API 26)
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-android:
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: sme-arena-armv7-linux-androideabi-debug
        path: ./apk

    - name: Setup Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        script: |
          echo "🤖 Android emulator started"
          adb install ./apk/sme-arena-game.apk

          # Launch app and verify it starts
          adb shell am start -n com.sme_arena_game/.MainActivity
          sleep 5

          # Check if app is running
          if adb shell pidof com.sme_arena_game > /dev/null; then
            echo "✅ Application started successfully"
          else
            echo "❌ Application failed to start"
            exit 1
          fi

          # Capture some logs
          timeout 10 adb logcat | grep "sme_arena" || true

  performance-analysis:
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: sme-arena-armv7-linux-androideabi-release
        path: ./release-apk

    - name: Analyze APK Performance
      run: |
        APK_PATH="./release-apk/sme-arena-game.apk"

        if [ -f "$APK_PATH" ]; then
          # Total size
          TOTAL_SIZE=$(du -h "$APK_PATH" | cut -f1)

          # Extract and analyze
          unzip -q "$APK_PATH" -d temp_apk/

          # Main asset sizes
          NATIVE_SIZE=$(du -sh temp_apk/lib/ 2>/dev/null | cut -f1 || echo "N/A")
          ASSETS_SIZE=$(du -sh temp_apk/assets/ 2>/dev/null | cut -f1 || echo "N/A")

          # Create report
          cat << EOF > performance_report.md
          # 📊 APK Performance Report

          ## 📦 Sizes
          - **Total APK:** $TOTAL_SIZE
          - **Native libraries:** $NATIVE_SIZE
          - **Assets:** $ASSETS_SIZE

          ## 🔍 Detailed Analysis
          \`\`\`
          $(unzip -l "$APK_PATH" | head -20)
          \`\`\`

          ## 📈 Recommendations
          $([ "$TOTAL_SIZE" \> "50M" ] && echo "⚠️ APK > 50MB - Consider optimization" || echo "✅ APK size acceptable")
          EOF

          # Add to GitHub summary
          cat performance_report.md >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: performance_report.md
        retention-days: 90
